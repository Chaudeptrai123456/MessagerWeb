services:
  debezium:
    image: debezium/connect:2.7
    environment:
      BOOTSTRAP_SERVERS: kafka:9092
      GROUP_ID: 1
      CONFIG_STORAGE_TOPIC: connect_configs
      OFFSET_STORAGE_TOPIC: connect_offsets
      STATUS_STORAGE_TOPIC: connect_statuses
    ports:
      - "8088:8088"
  localai:
    image: localai/localai:v3.6.0-aio-gpu-nvidia-cuda-12
    container_name: localai
    restart: unless-stopped
    # Chạy bằng user không phải root (UID:GID -> thay 1000:1000 nếu cần)
    user: "0:0"
    # Bind chỉ trên localhost để không expose public
    ports:
      - "8080:8080"
    # Mount models read-only để tránh bị sửa từ trong container
    volumes:
      - ./models.yaml:/models/models.yaml
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ "0" ]
              capabilities: [ "gpu" ]
        limits:
          cpus: "4.0"
          memory: 8G
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false   # -> đặt true nếu chắc chắn không cần ghi filesystem
    environment:
      - MODEL_DOWNLOADS=true
    networks:
      - app-network
  node-server:
    build:
      context: ../node-server
      dockerfile: Dockerfile
    depends_on:
      - postgres-replica
    container_name: node-server
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      NODE_ENV: docker
    networks:
      - app-network

  backend:
    build: .
    container_name: backend
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
      - kafka
    environment:
      SPRING_PROFILES_ACTIVE: docker
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres:5432/ecommerce
      SPRING_DATASOURCE_USERNAME: master
      SPRING_DATASOURCE_PASSWORD: 123
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    ports:
      - "9999:9999"
    networks:
      - app-network
  postgres:
    image: postgres:18
    container_name: postgres-master
    restart: always
    environment:
      POSTGRES_DB: ecommerce
      POSTGRES_USER: master
      POSTGRES_PASSWORD: 123
    ports:
      - "5432:5432"
    volumes:
      - message_postgres_data:/var/lib/postgresql
      - ./master/init-master.sh:/docker-entrypoint-initdb.d/init-master.sh:ro
      - ./master/pg_hba.conf:/var/lib/postgresql/data/pg_hba.conf:ro
    #      - ./master/init-master.sh:/docker-entrypoint-initdb.d/init-master.sh:ro
    networks:
      - app-network
  postgres-replica:
    image: postgres:18
    container_name: postgres-replica
    restart: always
    depends_on:
      - postgres
    environment:
      POSTGRES_USER: repuser
      POSTGRES_PASSWORD: replica_pass
      POSTGRES_DB: ecommerce
      PGPASSWORD: replica_pass
      PGDATA: /var/lib/postgresql/18/main
    ports:
      - "5433:5432"
    volumes:
      - ./replica/replica-entrypoint.sh:/replica-entrypoint.sh:ro
      - replica-data:/var/lib/postgresql
    entrypoint: [ "/bin/bash", "/replica-entrypoint.sh" ]
    networks:
      - app-network
  redis:
    image: redis:7
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - app-network

  qdrant:
    image: qdrant/qdrant:v1.15.1
    container_name: qdrant
    ports:
      - "6333:6333"   # HTTP API
      - "6334:6334"   # gRPC API
    volumes:
      - ./qdrant_data:/qdrant/storage
    environment:
      QDRANT__AUTH__API_KEY: ${QDRANT_API_KEY}
      QDRANT__SERVICE__HOST: 0.0.0.0
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__SERVICE__HTTP_PORT: 6333
      QDRANT__LOG_LEVEL: INFO
    networks:
      - app-network
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.4
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - 22181:2181

  kafka:
    image: confluentinc/cp-kafka:7.4.4
    depends_on:
      - zookeeper
    ports:
      - 29092:29092
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1


volumes:
  message_postgres_data:
  message_kafka_data:
  message_zookeeper_data:
  replica-data:

networks:
  backend_app-network :
    driver: bridge
  app-network:
    driver: bridge

#    PS D:\Server\MessagerWeb\backend> docker exec -it postgres psql -U user -d ecommerce
#    psql (18.0 (Debian 18.0-1.pgdg13+3))
#    Type "help" for help.
#
#    ecommerce=# CREATE USER reading_user WITH PASSWORD '123';
#    ALTER ROLE reading_user WITH REPLICATION;
#
#    GRANT CONNECT ON DATABASE ecommerce TO reading_user;
#    GRANT SELECT ON ALL TABLES IN SCHEMA public TO reading_user;
#    GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO reading_user;
#    GRANT USAGE ON SCHEMA public TO reading_user;
#    ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT SELECT ON TABLES TO reading_user;
#    CREATE ROLE
#    ALTER ROLE
#    GRANT
#    GRANT
#    GRANT
#    GRANT
#    ALTER DEFAULT PRIVILEGES
#  -- Xoá nếu đã tồn tại (cho chắc)
#  DROP ROLE IF EXISTS readonly_user;
#
#  -- 1️⃣ Tạo user mới có quyền LOGIN
#  CREATE ROLE readonly_user WITH LOGIN PASSWORD 'password123';
#
#  -- 2️⃣ Cho phép connect vào database ecommerce
#  GRANT CONNECT ON DATABASE ecommerce TO reacdmdonly_user;
#
#  -- 3️⃣ Cho phép truy cập vào schema public
#  GRANT USAGE ON SCHEMA public TO readonly_user;
#
#  -- 4️⃣ Cho quyền SELECT trên tất cả các bảng hiện tại trong schema public
#  GRANT SELECT ON ALL TABLES IN SCHEMA public TO readonly_user;
#
#  -- 5️⃣ Cho quyền SELECT trên tất cả các sequences (đề phòng có auto increment)
#  GRANT SELECT ON ALL SEQUENCES IN SCHEMA public TO readonly_user;
#
#  -- 6️⃣ Tự động cấp quyền SELECT cho các bảng và sequence được tạo sau này
#  ALTER DEFAULT PRIVILEGES IN SCHEMA public
#  GRANT SELECT ON TABLES TO readonly_user;
#
#  ALTER DEFAULT PRIVILEGES IN SCHEMA public
#  GRANT SELECT ON SEQUENCES TO readonly_user;
